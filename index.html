<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Check-in Control</title>

  <!-- PWA -->
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- CSS -->
  <link rel="preload" href="style.css" as="style">
  <link rel="stylesheet" href="style.css" />

  <!-- Estilos adicionales locales -->
  <style>
    .hidden{display:none}
    .questions{margin:10px 0 14px 20px;padding:0}
    .questions li{margin:8px 0 10px;line-height:1.35}
    .questions label{margin-left:10px;margin-right:8px;user-select:none}
    .evidence-preview img{max-width:160px;max-height:160px;border-radius:10px;object-fit:cover}
    /* === Mensaje de permisos de cámara === */
    #camera-permission-msg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:9999;text-align:center;padding:20px}
    #camera-permission-msg.active{display:flex}
    #camera-permission-msg .msg-box{background:#fff;color:#111;padding:24px 30px;border-radius:14px;max-width:400px;box-shadow:0 8px 25px rgba(0,0,0,0.25);font-family:system-ui,Arial,sans-serif}
    #camera-permission-msg h3{margin:0 0 12px;color:#111;letter-spacing:.5px}
    #camera-permission-msg p{margin:10px 0 0;font-size:15px;line-height:1.5;color:#444}
    #camera-permission-msg .btn-play{display:inline-flex;align-items:center;gap:10px;border:none;border-radius:999px;cursor:pointer;padding:14px 22px;font-weight:800;letter-spacing:.3px;background:#3b82f6;color:#fff;box-shadow:0 12px 32px rgba(59,130,246,.35);transition:transform .06s ease,box-shadow .18s ease;margin-top:6px}
    #camera-permission-msg .btn-play:active{transform:scale(.98)}
    #camera-permission-msg .btn-play:hover{box-shadow:0 16px 42px rgba(59,130,246,.45)}
    #camera-permission-msg .hint{margin:12px 0 0;font-size:13px;color:#6b7280}
  </style>

  <!-- jsQR local o fallback CDN -->
  <script src="./libs/jsQR.js" defer></script>
  <script>
    if (!window.jsQR) {
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
      document.head.appendChild(script);
    }
  </script>

  <!-- Firebase (compat) - CDN (crítico para conectividad) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js" defer></script>

  <!-- Config de tu proyecto (define window.firebaseConfig) -->
  <script src="firebase-config.js" defer></script>

  <!-- Tu lógica -->
  <script src="script.js" defer></script>

  <!-- Registro de Service Worker (por si aún no lo haces en script.js) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {/* noop */});
      });
    }
  </script>
</head>
<body>
  <noscript>
    <div style="padding:12px;background:#222;color:#fff;text-align:center">
      This application requires JavaScript enabled to work (including offline mode).
    </div>
  </noscript>

  <!-- Camera / Scanner -->
  <div id="scanner-container">
    <video id="video" playsinline></video>
    <div id="scan-box-overlay"></div>
    <div class="scanner-header">Point at the QR code</div>
  </div>

  <!-- Hidden canvas -->
  <canvas id="canvas" hidden></canvas>

  <!-- Modal after scan -->
  <div id="options-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Check-in Point</h3>
      <p id="scanned-point-name">—</p>
      <div class="button-group">
        <button id="btn-con-novedad" class="btn-novedad btn btn-warn">CON INCIDENTE</button>
        <button id="btn-sin-novedad" class="btn-normal btn btn-primary">SIN INCIDENTE</button>
      </div>
      <button id="btn-cancel-scan" class="btn-cancel btn">Cancel</button>
    </div>
  </div>

  <!-- NO INCIDENT form -->
  <div id="form-sin-novedad-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Registro sin Incidente</h3>
      <p>Punto: <strong id="point-name-sin-novedad"></strong></p>
      <form id="form-sin-novedad">
        <input type="text" id="agent-name-sin-novedad" placeholder="Ingresa tu Nombre y Apellido" required />
        <button type="submit" class="btn-submit btn btn-primary">Aceptar y Guardar</button>
        <button type="button" class="btn-cancel form-cancel btn">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- CON INCIDENTE form -->
  <div id="form-con-novedad-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Registro de Incidente</h3>
      <p>Punto: <strong id="point-name-con-novedad"></strong></p>
      <form id="form-con-novedad">
        <input type="text" id="agent-name-con-novedad" placeholder="Ingresa tu Nombre y Apellido" required />
        <textarea id="observation-text" placeholder="Describe la observación aquí..." rows="4" required></textarea>

        <!-- Evidence -->
        <div class="evidence-block">
          <label class="evidence-title">Evidencia (opcional)</label>
          <div class="evidence-actions">
            <button type="button" id="btn-evidencia" class="btn btn-warn">CAPTURAR EVIDENCIA</button>
            <input type="file" id="evidence-input" accept="image/*" capture="environment" hidden />
          </div>
          <div class="evidence-preview" id="evidence-preview-wrap" style="display:none;">
            <img id="evidence-preview" alt="Vista previa de evidencia" />
            <button type="button" id="evidence-remove" class="btn">Eliminar</button>
          </div>
        </div>

        <button type="submit" class="btn-submit btn btn-primary">Aceptar y Guardar</button>
        <button type="button" class="btn-cancel form-cancel btn">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="status-toast" class=""></div>

  <!-- Connection Status Indicator -->
  <div id="connection-indicator" style="position:fixed; top:12px; right:12px; z-index:1001; display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:20px; background:#1c1c1e; border:1px solid #4a4a4c; font-size:12px; font-weight:600;">
    <div id="connection-dot" style="width:8px; height:8px; border-radius:50%; background:#f59e0b; animation: pulse 2s infinite;"></div>
    <span id="connection-text">Iniciando...</span>
  </div>

  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>

  <!-- Saving overlay -->
  <div id="saving-overlay" aria-hidden="true">
    <div class="so-backdrop"></div>
    <div class="so-card" role="dialog" aria-live="polite" aria-busy="true">
      <div class="so-spinner" aria-hidden="true"></div>
      <div class="so-check" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="54" height="54" aria-hidden="true">
          <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <div id="saving-msg" class="so-msg">Guardando…</div>
    </div>
  </div>

  <!-- Camera permission message (START ROUNDS + PLAY) -->
  <div id="camera-permission-msg">
    <div class="msg-box" role="dialog" aria-live="polite" aria-modal="true">
      <h3>INICIAR RONDAS</h3>
      <button id="start-scan-cta" class="btn-play" type="button" aria-label="Start QR scanner">
        <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
          <path d="M8 5v14l11-7z" fill="currentColor"></path>
        </svg>
        <span>INICIAR</span>
      </button>
      <p class="hint">Al tocar "INICIAR" se solicitará permiso de cámara.</p>
    </div>
  </div>

  <!-- Evidence sheet (Camera / Gallery) -->
  <div id="sheet-evidencia" class="sheet hidden" role="dialog" aria-modal="true">
    <div class="sheet-card">
      <h3>Agregar evidencia</h3>
      <button id="opt-cam" class="btn btn-primary">Abrir cámara</button>
      <button id="opt-gal" class="btn">Adjuntar de galería</button>
      <button id="opt-cancelar" class="btn btn-ghost">Cancelar</button>
    </div>
  </div>

  <!-- Additional gallery input -->
  <input id="evidence-input-gallery" type="file" accept="image/*" hidden />
</body>
</html>
